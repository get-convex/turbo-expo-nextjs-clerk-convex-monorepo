#!/bin/bash
# Generate executive vulnerability report from Trivy scan results

set -e

SCAN_FILE="${1:-scan.json}"
OUTPUT_FILE="${2:-security-report.md}"

if [ ! -f "$SCAN_FILE" ]; then
    echo "Error: Scan file not found: $SCAN_FILE"
    echo "Usage: $0 <scan-file.json> [output-file.md]"
    exit 1
fi

echo "Generating security report from $SCAN_FILE..."

# Generate markdown report
cat > "$OUTPUT_FILE" << EOF
# Security Vulnerability Report

**Generated:** $(date '+%Y-%m-%d %H:%M:%S')
**Scan File:** $SCAN_FILE

---

## Executive Summary

$(jq -r '
[.Results[].Vulnerabilities[]] |
{
  total: length,
  critical: ([.[] | select(.Severity == "CRITICAL")] | length),
  high: ([.[] | select(.Severity == "HIGH")] | length),
  medium: ([.[] | select(.Severity == "MEDIUM")] | length),
  low: ([.[] | select(.Severity == "LOW")] | length),
  fixable: ([.[] | select(.FixedVersion != "")] | length)
} |
"### Vulnerability Breakdown

| Severity | Count |
|----------|-------|
| **Critical** | \(.critical) |
| **High** | \(.high) |
| **Medium** | \(.medium) |
| **Low** | \(.low) |
| **Total** | \(.total) |

**Fixable Vulnerabilities:** \(.fixable) / \(.total)
**Fix Rate:** \((.fixable / .total * 100) | floor)%"
' "$SCAN_FILE")

---

## Priority Classification

$(jq -r '
[.Results[].Vulnerabilities[]] |
group_by(
  if .CVSS.nvd.V3Score >= 9.0 then "P1"
  elif .CVSS.nvd.V3Score >= 7.0 then "P2"
  elif .CVSS.nvd.V3Score >= 4.0 then "P3"
  else "P4"
  end
) |
map({
  priority: (.[0] | if .CVSS.nvd.V3Score >= 9.0 then "P1" elif .CVSS.nvd.V3Score >= 7.0 then "P2" elif .CVSS.nvd.V3Score >= 4.0 then "P3" else "P4" end),
  count: length,
  sla: (if .[0].CVSS.nvd.V3Score >= 9.0 then "7 days" elif .[0].CVSS.nvd.V3Score >= 7.0 then "30 days" elif .[0].CVSS.nvd.V3Score >= 4.0 then "90 days" else "No SLA" end)
}) |
"| Priority | Count | SLA |
|----------|-------|-----|" +
([.[] | "| **\(.priority)** | \(.count) | \(.sla) |"] | join("\n"))
' "$SCAN_FILE")

---

## Critical Vulnerabilities (P0/P1)

$(jq -r '
[.Results[].Vulnerabilities[] | select(.CVSS.nvd.V3Score >= 9.0)] |
if length > 0 then
  "| CVE | CVSS | Package | Fixed Version |
|-----|------|---------|---------------|" +
  ([.[] | "| \(.VulnerabilityID) | \(.CVSS.nvd.V3Score) | \(.PkgName) | \(.FixedVersion // "No fix available") |"] | join("\n"))
else
  "✅ No critical vulnerabilities found."
end
' "$SCAN_FILE")

---

## Action Items

### Immediate Action (P0/P1) - 7 Day SLA

$(jq -r '
[.Results[].Vulnerabilities[] | select(.CVSS.nvd.V3Score >= 9.0)] |
if length > 0 then
  [.[] | "- [ ] **\(.VulnerabilityID)** in \(.PkgName)" + (if .FixedVersion != "" then " → Upgrade to \(.FixedVersion)" else " (No fix available - implement mitigations)" end)] | join("\n")
else
  "None"
end
' "$SCAN_FILE")

### Upcoming Sprint (P2) - 30 Day SLA

$(jq -r '
[.Results[].Vulnerabilities[] | select(.CVSS.nvd.V3Score >= 7.0 and .CVSS.nvd.V3Score < 9.0)] |
if length > 0 then
  "**\(length) vulnerabilities** to address in upcoming sprint.\n\nTop 5:\n" +
  ([.[0:5][] | "- \(.VulnerabilityID) in \(.PkgName) (CVSS: \(.CVSS.nvd.V3Score))"] | join("\n"))
else
  "None"
end
' "$SCAN_FILE")

---

## Package Breakdown

### Most Vulnerable Packages

$(jq -r '
[.Results[].Vulnerabilities[]] |
group_by(.PkgName) |
map({
  package: .[0].PkgName,
  count: length,
  max_cvss: ([.[].CVSS.nvd.V3Score] | max)
}) |
sort_by(-.count) |
.[0:10] |
"| Package | Vulnerabilities | Max CVSS |
|---------|----------------|----------|" +
([.[] | "| \(.package) | \(.count) | \(.max_cvss) |"] | join("\n"))
' "$SCAN_FILE")

---

## Recommendations

### Short-term (0-30 days)

1. **Fix P1 vulnerabilities** - \$(jq '[.Results[].Vulnerabilities[] | select(.CVSS.nvd.V3Score >= 9.0)] | length' "$SCAN_FILE") critical issues require immediate attention
2. **Update vulnerable packages** - Focus on packages with multiple vulnerabilities
3. **Implement security gates** - Fail builds on new CRITICAL findings

### Medium-term (30-90 days)

1. **Address P2 vulnerabilities** - \$(jq '[.Results[].Vulnerabilities[] | select(.CVSS.nvd.V3Score >= 7.0 and .CVSS.nvd.V3Score < 9.0)] | length' "$SCAN_FILE") high-severity issues
2. **Review unfixed vulnerabilities** - Implement compensating controls
3. **Automated remediation** - Set up Dependabot or Renovate

### Long-term (90+ days)

1. **Reduce attack surface** - Remove unused dependencies
2. **Continuous monitoring** - Daily scans and alerts
3. **Security training** - Developer security awareness

---

## Appendix: Scan Metadata

$(jq -r '
"**Scan Tool:** Trivy
**Scan Date:** \(.CreatedAt)
**Scanner Version:** \(.SchemaVersion)
**Artifact:** \(.ArtifactName)
**Artifact Type:** \(.ArtifactType)"
' "$SCAN_FILE")

---

*Report generated automatically by vulnerability-report.sh*
EOF

echo "Report generated: $OUTPUT_FILE"
echo ""
echo "Summary:"
jq -r '[.Results[].Vulnerabilities[]] | {critical: ([.[] | select(.Severity == "CRITICAL")] | length), high: ([.[] | select(.Severity == "HIGH")] | length), total: length} | "  Critical: \(.critical)\n  High: \(.high)\n  Total: \(.total)"' "$SCAN_FILE"
