# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A note-taking app with AI summarization. Monorepo with a Next.js web app, React Native (Expo) mobile app, and a shared Convex backend. Authentication via Clerk. Optional OpenAI integration for note summaries.

## Monorepo Structure

```
apps/web          - Next.js 16 web app (App Router, Tailwind CSS v4, Clerk)
apps/native       - React Native app (Expo SDK 54, React Navigation, Clerk)
packages/backend  - Convex backend (schema, server functions, shared API types)
```

Package manager is **yarn** (v1 workspaces). Orchestrated by **Turborepo**.

Both apps depend on `@packages/backend` for shared Convex API types (imported as `@packages/backend/convex/_generated/dataModel`).

## Commands

```bash
# Install dependencies
yarn

# Run all apps + backend concurrently (turbo TUI)
yarn dev

# Run individual apps
yarn workspace web-app dev          # Next.js on localhost:3000
yarn workspace native-app dev       # Expo dev server
yarn workspace @packages/backend dev # Convex dev server (hot-reload functions)

# Build
yarn build                          # Build all packages via turbo
yarn workspace web-app build        # Build web only

# Type checking
yarn typecheck                      # All packages
yarn workspace web-app typecheck    # Web only (tsc --noEmit)
yarn workspace native-app typecheck # Native only
yarn workspace @packages/backend typecheck # Backend only (tsc --noEmit -p convex)

# Lint
yarn workspace web-app lint         # ESLint (next/core-web-vitals, flat config)

# Test
yarn workspace native-app test      # Jest (jest-expo preset, --passWithNoTests)

# Format
yarn format                         # Prettier across all packages

# Clean
yarn clean                          # Remove dist, .next, node_modules via turbo

# Backend setup (first time)
npm run setup --workspace packages/backend  # Convex project init + deploy
```

## Architecture

### Backend (Convex)

Server functions live in `packages/backend/convex/`. The `_generated/` directory is auto-generated by `npx convex dev` -- never edit these files.

- **schema.ts** - Database schema (currently one `notes` table with userId, title, content, summary)
- **notes.ts** - CRUD queries/mutations for notes. Uses `ctx.auth.getUserIdentity()` for user scoping
- **openai.ts** - AI summarization via `internalAction` + `internalMutation`. Triggered asynchronously via `ctx.scheduler.runAfter()`
- **utils.ts** - Convex deployment helpers

Pattern: Mutations that need side effects (like calling OpenAI) schedule an `internalAction` which then calls an `internalMutation` to save results back.

### Auth Flow

Both apps use `ConvexProviderWithClerk` to integrate Clerk auth with Convex's reactive client. User identity flows from Clerk -> Convex via JWT.

- Web: `apps/web/src/app/ConvexClientProvider.tsx` (client component wrapping ClerkProvider + ConvexProviderWithClerk)
- Native: `apps/native/ConvexClientProvider.tsx` (same pattern with `@clerk/clerk-expo`)

### Web App (Next.js)

- App Router with `src/` directory. Path alias `@/*` maps to `./src/*`
- Tailwind CSS v4 (CSS-first config in `globals.css` using `@theme` directive, PostCSS via `@tailwindcss/postcss`)
- UI primitives from Radix UI, styled with `class-variance-authority` + `tailwind-merge` (utility `cn()` in `src/lib/utils.ts`)
- Routes: `/` (marketing), `/notes` (dashboard), `/notes/[slug]` (note detail)
- Components organized: `components/common/`, `components/home/`, `components/notes/`

### Native App (Expo)

- Expo SDK 54 with New Architecture enabled
- React Navigation (native stack): LoginScreen -> NotesDashboardScreen -> InsideNoteScreen / CreateNoteScreen
- Custom fonts loaded via `expo-font` (Inter + Montserrat families)
- Metro config in `metro.config.js` handles monorepo module resolution

## Environment Variables

Each app needs a `.env.local` file (see `.example.env` in each app directory):

**apps/web/.env.local:**
- `NEXT_PUBLIC_CONVEX_URL` - from `packages/backend/.env.local` after Convex setup
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` - from Clerk dashboard
- `CLERK_SECRET_KEY` - from Clerk dashboard

**apps/native/.env.local:**
- `EXPO_PUBLIC_CONVEX_URL`
- `EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY`

**Convex dashboard env vars (server-side):**
- `CLERK_ISSUER_URL` - from Clerk JWT template (required)
- `OPENAI_API_KEY` - from OpenAI (optional, for AI summaries)

## Deployment

Web deploys to Vercel. The build command in `apps/web/vercel.json` runs `convex deploy` which deploys backend functions, then builds the Next.js app:

```bash
cd ../../packages/backend && npx convex deploy --cmd 'cd ../../apps/web && turbo run build' --cmd-url-env-var-name NEXT_PUBLIC_CONVEX_URL
```
